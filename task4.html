<!DOCTYPE html>
<html>
<head>
	<title>task4</title>
	<style type="text/css">
		
		#main-layer-canvas {
			background: green;
			position: absolute;
			width: 100%;
			height: 100%;
			left: 0;
			top: 0;
		}

		.sub-layer-canvas {
			width: 90px;
			height: 130px;
			position: absolute;
		}

		#start {
			position: absolute;
			top: 200px;
		}

	</style>
</head>
<body>
	<canvas id="main-layer-canvas"></canvas>
	<button id="start" onclick="action()">START</button>
	<script type="text/javascript">

		function createCards() {
			let suits = ['C', 'H', 'S', 'D'];
			let values = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
			let layersCount = 1;
			let offset = 15;

			//створюємо карти наступним чином, на кожному створеному канвасі буде одна карта
			for (let i = 0; i < values.length; i++) {
				for (let j = 0; j < suits.length; j++) {
					//створюємо новий канвас, що міситиме зображення карти
					let subLayer = document.createElement('canvas');
					let ctxSubLayer = subLayer.getContext('2d');

					subLayer.setAttribute('class', 'sub-layer-canvas');
					subLayer.setAttribute('id', 'sub-layer' + layersCount);
					subLayer.setAttribute('name', 'cards/' + values[i] + suits[j] + '.png');

					//додаємо можливість рухати карти
					subLayer.onmousedown = function () {
						let coords = subLayer.getBoundingClientRect();
						let shiftX = event.pageX - coords.left;
						let shiftY = event.pageY - coords.top;

						document.onmousemove = function (event) {
							subLayer.style.left = event.pageX - shiftX + 'px';
							subLayer.style.top = event.pageY - shiftY + 'px';
						}

						subLayer.onmouseup = function () {
							document.onmousemove = null;
							subLayer.onmousedup = null;
						}					
					}

					subLayer.onclick = function () {
						subLayer.style.transition = '1s';
						subLayer.style.transform = 'rotateY(360deg)';

						let front = new Image();
						front.src = subLayer.getAttribute('name');
						front.onload = function () {
							setTimeout(function() {
								ctxSubLayer.drawImage(front, 0, 0, subLayer.width, subLayer.height);
								subLayer.style.transition = 'none';
							}, 235);
						}
					}

					subLayer.style.left = offset + 'px';
					document.body.appendChild(subLayer);

					//малюємо на новому канвасі карту
					let image = new Image();
					image.src = 'cards/back.png';
					image.onload = function () {
						ctxSubLayer.drawImage(image, 0, 0, subLayer.width, subLayer.height);
					}

					layersCount++;
					offset += 2;
				}
			}
		}

		//функція, що рухає карту
		function moveCard(card, x, y) {
			let style = window.getComputedStyle(card);
			let left = parseInt(style.getPropertyValue('left'));
			let top = parseInt(style.getPropertyValue('top'));

			let finalX = y * 200 + 340;
			let finalY = x * 50 + 150;

			let timer = setInterval(move, 1/100);

			function move() {
				if (left > finalX) {
					clearInterval(timer);
				} else {
					if (top < finalY) {
						top++;
						card.style.top = top + 'px';
					}

					left += 2;
					card.style.left = left + 'px';
				}
			}
		}

		function flipHorizontally(layer){
			let ctx = layer.getContext('2d');
			layer.style.transition = '1s';
			layer.style.transform = 'rotateY(360deg)';

			let front = new Image();
			front.src = layer.getAttribute('name');
			front.onload = function () {
				setTimeout(function() {
					ctx.drawImage(front, 0, 0, layer.width, layer.height);
				}, 235);
			}
		}

		function action() {
			let cardsTable = [[],[],[],[],[],[],[]];
			let cardsCount = 1;
			let amount = 0;

			let canvasMain = document.getElementById('main-layer-canvas');
			let ctxMain = canvasMain.getContext('2d');

			//місце для тузів
			ctxMain.strokeRect(540, 150, 90, 130);
			ctxMain.strokeRect(740, 150, 90, 130);
			ctxMain.strokeRect(940, 150, 90, 130);
			ctxMain.strokeRect(1040, 150, 90, 130);

			//створюємо карти
			createCards();
			let i, j;

			//розташовуємо карти у таблицю за зростанням
			for (i = 0; i < 7; i++) {
				j = amount;
				while (j < 6) {
					cardsTable[i][j] = document.getElementById('sub-layer' + cardsCount);
					cardsCount++;
					j++;
				}
				amount++;
			}
			//рухаємо карти
			for (i = 0; i < 7; i++) {
				for (j = 0; j < 6; j++) {
					if (cardsTable[i][j] != undefined) {
						moveCard(cardsTable[i][j], i, j);
					}
				}
			}

			for (i = 0; i < 7; i++) {
				for (j = 0; j < 6; j++) {
					//якщо ми на останній знизу карті
					if (cardsTable[i][j] != undefined && cardsTable[i][j - 1] === undefined) {
						//то перевернімо її догори
						flipHorizontally(cardsTable[i][j]);
					}
				}
			}
			//додаємо карти до прикупу
			let temp = 1;
			for (i = 22; i < 30; i++) {
				let card = document.getElementById('sub-layer' + i);
				moveCard(card, temp, 0);
				flipHorizontally(card);
				temp++;
			}
		}

	</script>
</body>
</html>